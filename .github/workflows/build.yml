name: Gradle Build & Draft Release

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

permissions:
  contents: write   # REQUIRED to create releases

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up JDK 21
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # 3. Make gradlew executable
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # 4. Clean project
      - name: Clean project
        run: |
          ./gradlew clean
          rm -rf .gradle/loom-cache
          rm -rf .gradle/caches
          ./gradlew --refresh-dependencies

      # 5. Build project
      - name: Build project
        run: ./gradlew build

      # 6. Run tests
      - name: Run tests
        run: ./gradlew test

      # 7. Read mod version from gradle.properties
      - name: Read mod version
        id: version
        run: |
          VERSION=$(grep "^mod_version=" gradle.properties | cut -d'=' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # 8. Find built JAR
      - name: Find JAR
        id: jar
        run: |
          JAR=$(ls build/libs/*.jar | grep -v sources | grep -v dev | head -n 1)
          echo "jar=$JAR" >> $GITHUB_OUTPUT

      # 9. Create DRAFT GitHub Release
      - name: Create draft release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: boundsoul-${{ steps.version.outputs.version }}
          name: boundsoul-${{ steps.version.outputs.version }}
          draft: true
          prerelease: false
          files: |
            ${{ steps.jar.outputs.jar }}